<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Break My Code</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Segoe UI', system-ui, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 12px 24px;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    header h1 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #e1e1e1;
      letter-spacing: 0.02em;
    }

    header span {
      font-size: 0.75rem;
      color: #6e6e6e;
    }

    #editor-container {
      flex: 1;
      min-height: 0;
    }

    #actions {
      padding: 12px 24px;
      border-top: 1px solid #333;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    #break-btn {
      background: #c0392b;
      color: #fff;
      border: none;
      padding: 8px 28px;
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      cursor: pointer;
      border-radius: 3px;
      text-transform: uppercase;
      transition: background 0.15s;
    }

    #break-btn:hover { background: #e74c3c; }
    #break-btn:disabled { background: #555; cursor: not-allowed; }

    #status-text {
      font-size: 0.8rem;
      color: #6e6e6e;
    }

    #results {
      height: 220px;
      overflow-y: auto;
      padding: 12px 24px;
      font-family: 'Cascadia Code', 'Fira Code', monospace;
      font-size: 0.82rem;
      line-height: 1.8;
      background: #141414;
    }

    #results:empty::before {
      content: 'Results will appear here...';
      color: #444;
    }

    .level-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .level-icon { width: 16px; text-align: center; margin-top: 1px; }

    .level-name { color: #9cdcfe; font-weight: 600; min-width: 180px; }

    .level-status-passed { color: #4ec94e; }
    .level-status-broken { color: #f44747; }
    .level-status-warning { color: #d7ba7d; }
    .level-status-running { color: #6e6e6e; }

    .level-details {
      margin-left: 26px;
      color: #888;
      white-space: pre-wrap;
      font-size: 0.78rem;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .spinning { display: inline-block; animation: spin 1s linear infinite; }
  </style>
</head>
<body>

  <header>
    <h1>Break My Code</h1>
    <span>paste your Python · we'll break it</span>
  </header>

  <div id="editor-container"></div>

  <div id="actions">
    <button id="break-btn">Break My Code</button>
    <span id="status-text"></span>
  </div>

  <div id="results"></div>

  <!-- Monaco Editor -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/vs/loader.js"></script>
  <script>
    const DEFAULT_CODE = `def fibonacci(n):
    if n == 0:
        return 0
    elif n == 1:
        return 1
    else:
        return fibonacci(n - 1) + fibonacci(n - 2)


def divide(a, b):
    return a / b


def first_item(items):
    return items[0]
`;

    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/vs' } });
    require(['vs/editor/editor.main'], function () {
      window.editor = monaco.editor.create(document.getElementById('editor-container'), {
        value: DEFAULT_CODE,
        language: 'python',
        theme: 'vs-dark',
        fontSize: 14,
        fontFamily: "'Cascadia Code', 'Fira Code', monospace",
        minimap: { enabled: false },
        scrollBeyondLastLine: false,
        lineNumbers: 'on',
        renderLineHighlight: 'all',
        padding: { top: 12 },
        automaticLayout: true,
      });
    });

    const LEVEL_NAMES = {
      1: 'Static Analysis',
      2: 'Naive Runtime',
      3: 'Edge Case Fuzzing',
      4: 'Behavioral Analysis',
      5: 'Deep Adversarial',
    };

    const ICONS = { passed: '✓', broken: '✗', warning: '⚠', running: '⟳' };

    function appendLevel(data) {
      const results = document.getElementById('results');
      const id = `level-${data.level}`;
      let row = document.getElementById(id);

      if (!row) {
        row = document.createElement('div');
        row.id = id;
        results.appendChild(row);
      }

      const icon = ICONS[data.status] || '⟳';
      const spinning = data.status === 'running' ? 'spinning' : '';
      const statusClass = `level-status-${data.status}`;
      const name = LEVEL_NAMES[data.level] || `Level ${data.level}`;

      let details = '';
      if (data.details) {
        details = `<div class="level-details">${escapeHtml(data.details)}</div>`;
      }

      row.innerHTML = `
        <div class="level-row">
          <span class="level-icon ${spinning}">${icon}</span>
          <span class="level-name">Level ${data.level} · ${name}</span>
          <span class="${statusClass}">${data.status.toUpperCase()}</span>
        </div>
        ${details}
      `;

      results.scrollTop = results.scrollHeight;
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    document.getElementById('break-btn').addEventListener('click', async () => {
      const code = window.editor?.getValue() ?? '';
      if (!code.trim()) return;

      const btn = document.getElementById('break-btn');
      const statusText = document.getElementById('status-text');
      const results = document.getElementById('results');

      btn.disabled = true;
      results.innerHTML = '';
      statusText.textContent = 'Running…';

      try {
        const response = await fetch('/break', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code }),
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                appendLevel(data);
              } catch { /* skip malformed */ }
            }
          }
        }

        statusText.textContent = 'Done.';
      } catch (err) {
        statusText.textContent = 'Error: ' + err.message;
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
